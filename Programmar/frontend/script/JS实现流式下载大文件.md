# JS实现流式下载大文件

## 背景

在做个人项目中的点对点文件传输功能时，使用了传统的Blob模块来下载文件。

1. 这么做是非流式传输的，会带来一个问题，文件在下载到磁盘之前，数据会整份保存在内存中。
2. 一旦传输一个大一点的文件，比如10个G或者20个G，大多数消费者的终端都扛不住这样的内存占用。

我们需要找到一个方案，能在浏览器上实现点对点的大文件传输，而不用占用太大内存。

## 概念解释

### 流式传输

> 当流这个字出现在 IO 的上下文中，常指的得就是分段的读取和处理文件，这样在处理文件时（转换、传输），就不必把整个文件加载到内存中，大大的节省了内存空间的占用。

例如我们平时使用APP看视频时，并非直接把整个视频文件加载进内存，而是从网络上分段获取视频的部分数据进行播放，这样用户能得到一个较为连续的观看体验，也不用担心自己的内存被视频数据给挤爆。

- 流在节省资源上面是很有用的概念，他能用较少的资源保证最基础的用户体验。
- 使用流后的流畅性可能会降低。例如用户A在用APP看一个4K的电影，他需要保证他的网络带宽能支持实时传输大量数据以支持流数据的连续性，否则就会出现卡顿现象，因为数据播放完了，下一帧的流数据并未来得及到达用户终端。
- 使用流后如果不采取额外的保证手段，是无法获取过去已经流过来的流数据的，因为数据已经丢失了，也就是说，**流只能读取一次**。

### 非流式传输

和流式传输相反，指直接把数据全部加载到内存后，再执行相关操作。

- 在极端场景下，对硬件要求是无限高。
- 当然如果数据都能加载到内存里，流畅性确实会很高。

## 浏览器下载文件的方式

在常规操作中，我们要完成下载功能时有两种方案。

```javascript
// 第一类：页面跳转、打开
location.href
window.open
iframe.src
a[download].click()

// 第二类：Ajax
fetch('/api/download')
    .then(res => res.blob())
    .then(blob => {
        // FileReader.readAsDataURL()
        const url = URL.createObjectURL(blob)
        // 借助第一类方式：location.href、iframe.src、a[download].click()
        window.open(url)
    })
```

从代码中可以看出，第二类最终仍然会依赖第一类来完成下载。

> 而第一类的操作都会导致一个行为：页面级导航跳转
> 
> 所以我们可以总结得出浏览器的下载行为：
>
> - 在页面级的跳转请求中，检查响应头是否包含 Content-Disposition: attachment。对于 a[download] 和 createObjectURL的 url 跳转，可以理解为浏览器帮忙加上了这个响应头。
> - Ajax 发出的请求并不是页面级跳转请求，所以即使拥有下载响应头也不会触发下载行为。


## 两种下载方式的区别

第一类请求直接由**下载线程**接管，可以直接使用**流式传输**将数据下载到本地磁盘，整个下载通道都是流式的，**一边读取网络数据一边向本地磁盘写数据**。

![下载线程方式下载文件.png](../assets/下载线程方式下载文件.png)

第二类先由JS接管网络数据，再使用API将文件创建成url触发下载。

- API:
    1. Blob
    2. createObjectURL

![JS接管网络数据下载.png](../assets/JS接管网络数据下载.png)

注意，第二类下载方法，从JS线程到下载线程部分，所有数据都堆在内存了，一旦数据量很大，就可能挤爆内存。

## 实现流式传输的方式

从浏览器的下载方式来看，我们如果要实现流式传输，只能依靠第一类方法。

- Q: 为什么我们平时使用的下载按钮都没有占用内存的问题呢？
- A: 因为我们用的下载链接都是直接指向其对应的后端的，下载线程自己会发HTTP下载请求到对应的链接以下载文件，整个过程都是流式的。


- Q: 那么当我们的P2P文件传输系统，没有后端，不能使用HTTP请求下载文件时，又只能依赖下载线程该怎么办呢？
- A: **在每个前端终端伪造一个后端，作为代理服务器 (实现流式传输方法的核心思路)**。 

也就是说，我们需要让下载线程请求代理服务器，代理服务器来响应数据。而代理服务器向实际服务器请求数据，最终实现整条流式传输管道。


## 参考文献

1. [JS 实现流式打包下载](https://zhuanlan.zhihu.com/p/446145066)